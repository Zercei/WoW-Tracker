<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WoW Gear Tracker</title>
    <style>
        #saveButton {
            margin-top: 20px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        #loginDiv {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <select id="specSelect">
        <option value="">Select Specialization</option>
    </select>

    <table id="gearTable">
        <tr>
            <th>Slot</th>
            <th>Equipped</th>
            <th>Ideal</th>
            <th>Stat1</th>
            <th>Stat2</th>
            <th>AGI</th>
            <th>Haste</th>
            <th>Mastery</th>
            <th>Crit</th>
            <th>Vers</th>
            <th>Action</th>
        </tr>
    </table>

    <button id="saveButton">Save Data</button>

    <div id="loginDiv">
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <button id="loginButton">Login</button>
        <button id="registerButton">Register</button>
    </div>

    <!-- Add Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>

    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentSpec = null;
        const table = document.getElementById('gearTable');
        const specSelect = document.getElementById('specSelect');

        const specializations = ["Fire Mage", "Shadow Priest"];  // Add all your specializations here

        // Authentication functions
        function login() {
            var email = document.getElementById('loginEmail').value;
            var password = document.getElementById('loginPassword').value;
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log('Logged in');
                    document.getElementById('loginDiv').style.display = 'none';
                    loadData();
                })
                .catch((error) => {
                    console.error('Error logging in:', error);
                });
        }

        function register() {
            var email = document.getElementById('loginEmail').value;
            var password = document.getElementById('loginPassword').value;
            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log('User registered');
                    document.getElementById('loginDiv').style.display = 'none';
                    loadData();
                })
                .catch((error) => {
                    console.error('Error registering:', error);
                });
        }

        // Save data function
        function saveData() {
            if (!currentSpec) {
                console.log("No specialization selected. Can't save data.");
                return;
            }
            const data = {};
            const inputs = table.querySelectorAll('input, select');
            inputs.forEach(input => {
                data[input.name] = input.value;
            });

            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    db.collection('users').doc(user.uid).collection('gearData').doc(currentSpec).set(data)
                        .then(() => {
                            console.log(`Data saved for ${currentSpec}:`, data);
                        })
                        .catch((error) => {
                            console.error("Error saving data:", error);
                        });
                }
            });
        }

        // Load data function
        function loadData() {
            if (!currentSpec) {
                console.log("No specialization selected. Can't load data.");
                return;
            }

            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    db.collection('users').doc(user.uid).collection('gearData').doc(currentSpec).get()
                        .then((doc) => {
                            if (doc.exists) {
                                const data = doc.data();
                                console.log(`Data loaded for ${currentSpec}:`, data);
                                const inputs = table.querySelectorAll('input, select');
                                inputs.forEach(input => {
                                    if (data[input.name]) {
                                        input.value = data[input.name];
                                        if (input.type === 'number') {
                                            highlightStatInput(input);
                                        }
                                    } else {
                                        if (input.type === 'number' || input.type === 'text') {
                                            input.value = '';
                                        } else if (input.type === 'select-one') {
                                            input.selectedIndex = 0;
                                        }
                                    }
                                });
                                updateTotals();
                            }
                        })
                        .catch((error) => {
                            console.error("Error loading data:", error);
                        });
                }
            });
        }

        function loadSpecialization(spec) {
            console.log("Switching to specialization:", spec);
            if (currentSpec) {
                saveData(); // Save current spec data before switching
            }
            currentSpec = spec;
            createTable();
            loadData();
            document.title = `WoW Gear Tracker - ${spec}`;
        }

        function createTable() {
            // Your existing createTable logic here
        }

        function updateStatColor(select) {
            // Your existing updateStatColor logic here
        }

        function updateTotals() {
            // Your existing updateTotals logic here
        }

        function highlightStatInput(input) {
            // Your existing highlightStatInput logic here
        }

        function clearRow(button) {
            // Your existing clearRow logic here
        }

        // Initialize table
        createTable();

        // Event listeners
        table.addEventListener('input', function(e) {
            if (e.target.type === 'number') {
                updateTotals();
                highlightStatInput(e.target);
            }
            console.log("Input changed, saving data...");
            saveData();
        });

        specSelect.addEventListener('change', function(e) {
            loadSpecialization(e.target.value);
        });

        // Manual save button
        document.getElementById('saveButton').addEventListener('click', function() {
            console.log("Manual save initiated...");
            saveData();
        });

        // Save data when the page is about to be unloaded
        window.addEventListener('beforeunload', function() {
            console.log("Page unloading, saving data...");
            saveData();
        });

        // Initialize stat colors
        document.querySelectorAll('select').forEach(updateStatColor);

        // Populate specialization dropdown
        specializations.forEach(spec => {
            const option = document.createElement('option');
            option.value = spec;
            option.textContent = spec;
            specSelect.appendChild(option);
        });

        // Add event listeners to login and register buttons
        document.getElementById('loginButton').addEventListener('click', login);
        document.getElementById('registerButton').addEventListener('click', register);

        console.log("Script initialized");
    </script>
</body>
</html>
